{"version":3,"file":"graph.photos.js","sourceRoot":"src/","sources":["graph/graph.photos.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * -------------------------------------------------------------------------------------------\n * Copyright (c) Microsoft Corporation.  All Rights Reserved.  Licensed under the MIT License.\n * See License in the project root for license information.\n * -------------------------------------------------------------------------------------------\n */\n\nimport { IGraph, prepScopes, CacheItem, CacheService, CacheStore } from '@microsoft/mgt-element';\nimport { ResponseType } from '@microsoft/microsoft-graph-client';\nimport * as MicrosoftGraph from '@microsoft/microsoft-graph-types';\nimport { Person, ProfilePhoto } from '@microsoft/microsoft-graph-types';\n\nimport { blobToBase64 } from '../utils/Utils';\nimport { schemas } from './cacheStores';\nimport { findContactsByEmail, getEmailFromGraphEntity } from './graph.people';\nimport { findUsers } from './graph.user';\nimport { IDynamicPerson } from './types';\n\n/**\n * photo object stored in cache\n */\nexport interface CachePhoto extends CacheItem {\n  /**\n   * user tag associated with photo\n   */\n  eTag?: string;\n  /**\n   * user/contact photo\n   */\n  photo?: string;\n}\n\n/**\n * Defines expiration time\n */\nexport const getPhotoInvalidationTime = () =>\n  CacheService.config.photos.invalidationPeriod || CacheService.config.defaultInvalidationPeriod;\n\n/**\n * Whether photo store is enabled\n */\nexport const getIsPhotosCacheEnabled = () => CacheService.config.photos.isEnabled && CacheService.config.isEnabled;\n\n/**\n * retrieves a photo for the specified resource.\n *\n * @param {string} resource\n * @param {string[]} scopes\n * @returns {Promise<string>}\n */\nexport const getPhotoForResource = async (graph: IGraph, resource: string, scopes: string[]): Promise<CachePhoto> => {\n  try {\n    const response = (await graph\n      .api(`${resource}/photo/$value`)\n      .responseType(ResponseType.RAW)\n      .middlewareOptions(prepScopes(...scopes))\n      .get()) as Response;\n\n    if (response.status === 404) {\n      // 404 means the resource does not have a photo\n      // we still want to cache that state\n      // so we return an object that can be cached\n      return { eTag: null, photo: null };\n    } else if (!response.ok) {\n      return null;\n    }\n\n    const eTag = response['@odata.mediaEtag'] as string;\n    const blob = await blobToBase64(await response.blob());\n    return { eTag, photo: blob };\n  } catch (e) {\n    return null;\n  }\n};\n\n/**\n * async promise, returns Graph photos associated with contacts of the logged in user\n *\n * @param contactId\n * @returns {Promise<string>}\n * @memberof Graph\n */\nexport const getContactPhoto = async (graph: IGraph, contactId: string): Promise<string> => {\n  let cache: CacheStore<CachePhoto>;\n  let photoDetails: CachePhoto;\n  if (getIsPhotosCacheEnabled()) {\n    cache = CacheService.getCache<CachePhoto>(schemas.photos, schemas.photos.stores.contacts);\n    photoDetails = await cache.getValue(contactId);\n    if (photoDetails && getPhotoInvalidationTime() > Date.now() - photoDetails.timeCached) {\n      return photoDetails.photo;\n    }\n  }\n\n  photoDetails = await getPhotoForResource(graph, `me/contacts/${contactId}`, ['contacts.read']);\n  if (getIsPhotosCacheEnabled() && photoDetails) {\n    await cache.putValue(contactId, photoDetails);\n  }\n  return photoDetails ? photoDetails.photo : null;\n};\n\n/**\n * async promise, returns Graph photo associated with provided userId\n *\n * @param userId\n * @returns {Promise<string>}\n * @memberof Graph\n */\nexport const getUserPhoto = async (graph: IGraph, userId: string): Promise<string> => {\n  let cache: CacheStore<CachePhoto>;\n  let photoDetails: CachePhoto;\n\n  if (getIsPhotosCacheEnabled()) {\n    cache = CacheService.getCache<CachePhoto>(schemas.photos, schemas.photos.stores.users);\n    photoDetails = await cache.getValue(userId);\n    if (photoDetails && getPhotoInvalidationTime() > Date.now() - photoDetails.timeCached) {\n      return photoDetails.photo;\n    } else if (photoDetails) {\n      // there is a photo in the cache, but it's staleS\n      try {\n        const response = (await graph.api(`users/${userId}/photo`).get()) as ProfilePhoto;\n        if (\n          response &&\n          (response['@odata.mediaEtag'] !== photoDetails.eTag ||\n            (response['@odata.mediaEtag'] === null && photoDetails.eTag === null))\n        ) {\n          // set photoDetails to null so that photo gets pulled from the graph later\n          photoDetails = null;\n        }\n      } catch {\n        return null;\n      }\n    }\n  }\n\n  // if there is a photo in the cache, we got here because it was stale\n  photoDetails = photoDetails || (await getPhotoForResource(graph, `users/${userId}`, ['user.readbasic.all']));\n  if (getIsPhotosCacheEnabled() && photoDetails) {\n    await cache.putValue(userId, photoDetails);\n  }\n  return photoDetails ? photoDetails.photo : null;\n};\n\n/**\n * async promise, returns Graph photo associated with the logged in user\n *\n * @returns {Promise<string>}\n * @memberof Graph\n */\nexport const myPhoto = async (graph: IGraph): Promise<string> => {\n  let cache: CacheStore<CachePhoto>;\n  let photoDetails: CachePhoto;\n  if (getIsPhotosCacheEnabled()) {\n    cache = CacheService.getCache<CachePhoto>(schemas.photos, schemas.photos.stores.users);\n    photoDetails = await cache.getValue('me');\n    if (photoDetails && getPhotoInvalidationTime() > Date.now() - photoDetails.timeCached) {\n      return photoDetails.photo;\n    }\n  }\n\n  try {\n    const response = (await graph.api('me/photo').get()) as ProfilePhoto;\n    if (\n      response &&\n      (response['@odata.mediaEtag'] !== photoDetails.eTag ||\n        (response['@odata.mediaEtag'] === null && photoDetails.eTag === null))\n    ) {\n      photoDetails = null;\n    }\n  } catch {\n    return null;\n  }\n\n  photoDetails = photoDetails || (await getPhotoForResource(graph, 'me', ['user.read']));\n  if (getIsPhotosCacheEnabled()) {\n    await cache.putValue('me', photoDetails || {});\n  }\n\n  return photoDetails ? photoDetails.photo : null;\n};\n\n/**\n * async promise, loads image of user\n *\n * @export\n */\nexport const getPersonImage = async (graph: IGraph, person: IDynamicPerson, useContactsApis = true) => {\n  // handle if person but not user\n  if ('personType' in person && (person as Person).personType.subclass !== 'OrganizationUser') {\n    if ((person as Person).personType.subclass === 'PersonalContact' && useContactsApis) {\n      // if person is a contact, look for them and their photo in contact api\n      const contactMail = getEmailFromGraphEntity(person);\n      const contact = await findContactsByEmail(graph, contactMail);\n      if (contact?.length && contact[0].id) {\n        return await getContactPhoto(graph, contact[0].id);\n      }\n    }\n\n    return null;\n  }\n\n  // handle if user\n  if ((person as MicrosoftGraph.Person).userPrincipalName || person.id) {\n    // try to find a user by userPrincipalName\n    const id = (person as MicrosoftGraph.Person).userPrincipalName || person.id;\n    return await getUserPhoto(graph, id);\n  }\n\n  // else assume id is for user and try to get photo\n  if (person.id) {\n    const image = await getUserPhoto(graph, person.id);\n    if (image) {\n      return image;\n    }\n  }\n\n  // let's try to find a person by the email\n  const email = getEmailFromGraphEntity(person);\n\n  if (email) {\n    // try to find user\n    const users = await findUsers(graph, email, 1);\n    if (users?.length) {\n      return await getUserPhoto(graph, users[0].id);\n    }\n\n    // if no user, try to find a contact\n    if (useContactsApis) {\n      const contacts = await findContactsByEmail(graph, email);\n      if (contacts?.length) {\n        return await getContactPhoto(graph, contacts[0].id);\n      }\n    }\n  }\n\n  return null;\n};\n\n/**\n * Load the image for a group\n *\n * @param graph\n * @param group\n * @param useContactsApis\n * @returns\n */\nexport const getGroupImage = async (graph: IGraph, group: IDynamicPerson) => {\n  let photoDetails: CachePhoto;\n  let cache: CacheStore<CachePhoto>;\n\n  const groupId = group.id;\n\n  if (getIsPhotosCacheEnabled()) {\n    cache = CacheService.getCache<CachePhoto>(schemas.photos, schemas.photos.stores.groups);\n    photoDetails = await cache.getValue(groupId);\n    if (photoDetails && getPhotoInvalidationTime() > Date.now() - photoDetails.timeCached) {\n      return photoDetails.photo;\n    } else if (photoDetails) {\n      // there is a photo in the cache, but it's stale\n      try {\n        const response = (await graph.api(`groups/${groupId}/photo`).get()) as ProfilePhoto;\n        if (\n          response &&\n          (response['@odata.mediaEtag'] !== photoDetails.eTag ||\n            (response['@odata.mediaEtag'] === null && photoDetails.eTag === null))\n        ) {\n          // set photoDetails to null so that photo gets pulled from the graph later\n          photoDetails = null;\n        }\n      } catch {\n        return null;\n      }\n    }\n  }\n\n  // if there is a photo in the cache, we got here because it was stale\n  photoDetails = photoDetails || (await getPhotoForResource(graph, `groups/${groupId}`, ['user.readbasic.all']));\n  if (getIsPhotosCacheEnabled() && photoDetails) {\n    await cache.putValue(groupId, photoDetails);\n  }\n  return photoDetails ? photoDetails.photo : null;\n};\n\n/**\n * checks if user has a photo in the cache\n *\n * @param userId\n * @returns {CachePhoto}\n * @memberof Graph\n */\nexport const getPhotoFromCache = async (userId: string, storeName: string): Promise<CachePhoto> => {\n  const cache = CacheService.getCache<CachePhoto>(schemas.photos, storeName);\n  const item = await cache.getValue(userId);\n  return item;\n};\n\n/**\n * checks if user has a photo in the cache\n *\n * @param userId\n * @returns {void}\n * @memberof Graph\n */\nexport const storePhotoInCache = async (userId: string, storeName: string, value: CachePhoto): Promise<void> => {\n  const cache = CacheService.getCache<CachePhoto>(schemas.photos, storeName);\n  await cache.putValue(userId, value);\n};\n"]}