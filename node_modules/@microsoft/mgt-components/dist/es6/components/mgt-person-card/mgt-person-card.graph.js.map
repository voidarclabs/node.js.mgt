{"version":3,"file":"mgt-person-card.graph.js","sourceRoot":"src/","sources":["components/mgt-person-card/mgt-person-card.graph.ts"],"names":[],"mappings":"AAAA;;;;;GAKG;;;;;;;;;;AAEH,OAAO,EAAiC,UAAU,EAAE,MAAM,wBAAwB,CAAC;AAInF,OAAO,EAAE,uBAAuB,EAAE,MAAM,0BAA0B,CAAC;AAInE,MAAM,cAAc,GAClB,oKAAoK,CAAC;AAEvK,MAAM,SAAS,GAAG;IAChB,aAAa,EAAE,eAAe;IAC9B,KAAK,EAAE,OAAO;IACd,QAAQ,EAAE,UAAU;IACpB,MAAM,EAAE,QAAQ;IAChB,MAAM,EAAE,QAAQ;CACjB,CAAC;AAEF;;;;;;;;;GASG;AACH,MAAM,CAAC,MAAM,sBAAsB,GAAG,CACpC,KAAa,EACb,aAA6B,EAC7B,IAAa,EACb,MAA2B,EACE,EAAE;;IAC/B,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,CAAC;IAChC,MAAM,KAAK,GAAG,uBAAuB,CAAC,aAAa,CAAC,CAAC;IAErD,MAAM,gBAAgB,GACpB,gBAAgB,IAAI,aAAa;QACjC,CAAC,YAAY,IAAI,aAAa;YAC5B,CAAC,aAAa,CAAC,UAAU,CAAC,QAAQ,KAAK,iBAAiB,IAAI,aAAa,CAAC,UAAU,CAAC,KAAK,KAAK,OAAO,CAAC,CAAC,CAAC;IAE7G,MAAM,KAAK,GAAG,KAAK,CAAC,WAAW,EAAE,CAAC;IAElC,IAAI,CAAC,gBAAgB,EAAE;QACrB,IAAI,MAAM,CAAC,QAAQ,CAAC,YAAY,EAAE;YAChC,wBAAwB,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;YAExC,IAAI,OAAO,MAAM,CAAC,QAAQ,CAAC,YAAY,KAAK,SAAS,IAAI,MAAM,CAAC,QAAQ,CAAC,YAAY,CAAC,aAAa,EAAE;gBACnG,qBAAqB,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;aACtC;SACF;KACF;IAED,IAAI,MAAM,CAAC,QAAQ,CAAC,YAAY,IAAI,KAAK,EAAE;QACzC,4BAA4B,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;KAC5C;IAED,IAAI,MAAM,CAAC,QAAQ,CAAC,KAAK,EAAE;QACzB,iBAAiB,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;KAC/C;IAED,IAAI,QAAoC,CAAC;IACzC,MAAM,IAAI,GAAuB,EAAE,CAAC,CAAC,OAAO;IAC5C,IAAI;QACF,QAAQ,GAAG,MAAM,KAAK,CAAC,UAAU,EAAE,CAAC;KACrC;IAAC,WAAM;QACN,MAAM;KACP;IAED,IAAI,QAAQ,EAAE;QACZ,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,QAAQ,EAAE;YACnC,+GAA+G;YAC/G,IAAI,CAAC,GAAG,CAAC,GAAG,CAAA,MAAA,KAAK,CAAC,OAAO,0CAAE,KAAK,KAAI,KAAK,CAAC,OAAO,CAAC;SACnD;KACF;IAED,IAAI,CAAC,gBAAgB,IAAI,MAAM,CAAC,QAAQ,CAAC,OAAO,EAAE;QAChD,IAAI;YACF,MAAM,OAAO,GAAG,MAAM,UAAU,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;YAChD,IAAI,OAAO,EAAE;gBACX,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;aACxB;SACF;QAAC,WAAM;YACN,MAAM;SACP;KACF;IAED,iDAAiD;IACjD,IAAI,IAAI,CAAC,aAAa,IAAI,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,EAAE;QACvD,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,cAAc,CAAC,CAAC;KACjF;IAED,OAAO,IAAI,CAAC;AACd,CAAC,CAAA,CAAC;AAEF,MAAM,wBAAwB,GAAG,CAAC,KAAa,EAAE,MAAc,EAAE,EAAE;IACjE,MAAM,cAAc,GAAG,+BAA+B,cAAc,GAAG,CAAC;IAExE,KAAK,CAAC,GAAG,CACP,SAAS,CAAC,MAAM,EAChB,SAAS,MAAM,YAAY,cAAc,YAAY,cAAc,cAAc,EACjF,CAAC,eAAe,CAAC,EACjB;QACE,gBAAgB,EAAE,UAAU;KAC7B,CACF,CAAC;IAEF,KAAK,CAAC,GAAG,CAAC,SAAS,CAAC,aAAa,EAAE,SAAS,MAAM,0BAA0B,cAAc,EAAE,CAAC,CAAC;AAChG,CAAC,CAAC;AAEF,MAAM,qBAAqB,GAAG,CAAC,KAAa,EAAE,MAAc,EAAE,EAAE;IAC9D,KAAK,CAAC,GAAG,CAAC,SAAS,CAAC,MAAM,EAAE,SAAS,MAAM,8CAA8C,EAAE,CAAC,iBAAiB,CAAC,CAAC,CAAC;AAClH,CAAC,CAAC;AAEF,MAAM,4BAA4B,GAAG,CAAC,KAAa,EAAE,YAAoB,EAAE,EAAE;IAC3E,KAAK,CAAC,GAAG,CAAC,SAAS,CAAC,QAAQ,EAAE,6BAA6B,YAAY,GAAG,EAAE,CAAC,gBAAgB,CAAC,CAAC,CAAC;AAClG,CAAC,CAAC;AAEF,MAAM,iBAAiB,GAAG,CAAC,KAAa,EAAE,YAAqB,EAAE,EAAE;IACjE,IAAI,OAAe,CAAC;IAEpB,IAAI,YAAY,EAAE;QAChB,OAAO,GAAG,8DAA8D,YAAY,GAAG,CAAC;KACzF;SAAM;QACL,OAAO,GAAG,kBAAkB,CAAC;KAC9B;IAED,KAAK,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,EAAE,OAAO,EAAE,CAAC,gBAAgB,CAAC,CAAC,CAAC;AAC1D,CAAC,CAAC;AAEF;;;;;;GAMG;AACH,MAAM,UAAU,GAAG,CAAO,KAAa,EAAE,MAAc,EAAoB,EAAE,kDAC3E,OAAA,CAAC,MAAM,KAAK,CAAC,GAAG,CAAC,UAAU,MAAM,UAAU,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAY,CAAA,GAAA,CAAC;AAEjF;;;;;;;GAOG;AACH,MAAM,CAAC,MAAM,UAAU,GAAG,CAAO,KAAa,EAAE,MAAc,EAAE,IAAY,EAAiB,EAAE;IAC7F,MAAM,QAAQ,GAAG;QACf,QAAQ,EAAE,UAAU;QACpB,OAAO,EAAE;YACP;gBACE,aAAa,EAAE,4CAA4C;gBAC3D,KAAK,EAAE,CAAC,OAAO,CAAC;gBAChB,iBAAiB,EAAE,2CAA2C,IAAI,IAAI;aACvE;YACD;gBACE,aAAa,EAAE,4CAA4C;gBAC3D,KAAK,EAAE,CAAC,OAAO,CAAC;gBAChB,iBAAiB,EAAE,2CAA2C,MAAM,IAAI;aACzE;SACF;KACF,CAAC;IACF,OAAO,CAAC,MAAM,KAAK;SAChB,GAAG,CAAC,QAAQ,CAAC;SACb,MAAM,CAAC,eAAe,EAAE,UAAU,CAAC;SACnC,iBAAiB,CAAC,UAAU,CAAC,aAAa,EAAE,gBAAgB,CAAC,CAAC;SAC9D,IAAI,CAAC,QAAQ,CAAC,CAAS,CAAC;AAC7B,CAAC,CAAA,CAAC;AAEF;;;;;;;GAOG;AACH,MAAM,CAAC,MAAM,WAAW,GAAG,CACzB,KAAa,EACb,MAAc,EACd,WAAsC,EAChB,EAAE;IACxB,OAAA,CAAC,MAAM,KAAK;SACT,GAAG,CAAC,UAAU,MAAM,WAAW,CAAC;SAChC,MAAM,CAAC,eAAe,EAAE,UAAU,CAAC;SACnC,iBAAiB,CAAC,UAAU,CAAC,gBAAgB,EAAE,kBAAkB,CAAC,CAAC;SACnE,IAAI,CAAC,WAAW,CAAC,CAAgB,CAAA;EAAA,CAAC","sourcesContent":["/**\n * -------------------------------------------------------------------------------------------\n * Copyright (c) Microsoft Corporation.  All Rights Reserved.  Licensed under the MIT License.\n * See License in the project root for license information.\n * -------------------------------------------------------------------------------------------\n */\n\nimport { BatchResponse, IBatch, IGraph, prepScopes } from '@microsoft/mgt-element';\nimport { Chat, ChatMessage } from '@microsoft/microsoft-graph-types';\nimport { Profile } from '@microsoft/microsoft-graph-types-beta';\n\nimport { getEmailFromGraphEntity } from '../../graph/graph.people';\nimport { IDynamicPerson } from '../../graph/types';\nimport { MgtPersonCardConfig, MgtPersonCardState } from './mgt-person-card.types';\n\nconst userProperties =\n  'businessPhones,companyName,department,displayName,givenName,jobTitle,mail,mobilePhone,officeLocation,preferredLanguage,surname,userPrincipalName,id,accountEnabled';\n\nconst batchKeys = {\n  directReports: 'directReports',\n  files: 'files',\n  messages: 'messages',\n  people: 'people',\n  person: 'person'\n};\n\n/**\n * Get data to populate the person card\n *\n * @export\n * @param {IGraph} graph\n * @param {IDynamicPerson} personDetails\n * @param {boolean} isMe\n * @param {MgtPersonCardConfig} config\n * @return {*}  {Promise<MgtPersonCardState>}\n */\nexport const getPersonCardGraphData = async (\n  graph: IGraph,\n  personDetails: IDynamicPerson,\n  isMe: boolean,\n  config: MgtPersonCardConfig\n): Promise<MgtPersonCardState> => {\n  const userId = personDetails.id;\n  const email = getEmailFromGraphEntity(personDetails);\n\n  const isContactOrGroup =\n    'classification' in personDetails ||\n    ('personType' in personDetails &&\n      (personDetails.personType.subclass === 'PersonalContact' || personDetails.personType.class === 'Group'));\n\n  const batch = graph.createBatch();\n\n  if (!isContactOrGroup) {\n    if (config.sections.organization) {\n      buildOrgStructureRequest(batch, userId);\n\n      if (typeof config.sections.organization !== 'boolean' && config.sections.organization.showWorksWith) {\n        buildWorksWithRequest(batch, userId);\n      }\n    }\n  }\n\n  if (config.sections.mailMessages && email) {\n    buildMessagesWithUserRequest(batch, email);\n  }\n\n  if (config.sections.files) {\n    buildFilesRequest(batch, isMe ? null : email);\n  }\n\n  let response: Map<string, BatchResponse>;\n  const data: MgtPersonCardState = {}; // TODO\n  try {\n    response = await batch.executeAll();\n  } catch {\n    // nop\n  }\n\n  if (response) {\n    for (const [key, value] of response) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-member-access\n      data[key] = value.content?.value || value.content;\n    }\n  }\n\n  if (!isContactOrGroup && config.sections.profile) {\n    try {\n      const profile = await getProfile(graph, userId);\n      if (profile) {\n        data.profile = profile;\n      }\n    } catch {\n      // nop\n    }\n  }\n\n  // filter out disabled users from direct reports.\n  if (data.directReports && data.directReports.length > 0) {\n    data.directReports = data.directReports.filter(report => report.accountEnabled);\n  }\n\n  return data;\n};\n\nconst buildOrgStructureRequest = (batch: IBatch, userId: string) => {\n  const expandManagers = `manager($levels=max;$select=${userProperties})`;\n\n  batch.get(\n    batchKeys.person,\n    `users/${userId}?$expand=${expandManagers}&$select=${userProperties}&$count=true`,\n    ['user.read.all'],\n    {\n      ConsistencyLevel: 'eventual'\n    }\n  );\n\n  batch.get(batchKeys.directReports, `users/${userId}/directReports?$select=${userProperties}`);\n};\n\nconst buildWorksWithRequest = (batch: IBatch, userId: string) => {\n  batch.get(batchKeys.people, `users/${userId}/people?$filter=personType/class eq 'Person'`, ['People.Read.All']);\n};\n\nconst buildMessagesWithUserRequest = (batch: IBatch, emailAddress: string) => {\n  batch.get(batchKeys.messages, `me/messages?$search=\"from:${emailAddress}\"`, ['Mail.ReadBasic']);\n};\n\nconst buildFilesRequest = (batch: IBatch, emailAddress?: string) => {\n  let request: string;\n\n  if (emailAddress) {\n    request = `me/insights/shared?$filter=lastshared/sharedby/address eq '${emailAddress}'`;\n  } else {\n    request = 'me/insights/used';\n  }\n\n  batch.get(batchKeys.files, request, ['Sites.Read.All']);\n};\n\n/**\n * Get the profile for a user\n *\n * @param {IGraph} graph\n * @param {string} userId\n * @return {*}  {Promise<Profile>}\n */\nconst getProfile = async (graph: IGraph, userId: string): Promise<Profile> =>\n  (await graph.api(`/users/${userId}/profile`).version('beta').get()) as Profile;\n\n/**\n * Initiate a chat to a user\n *\n * @export\n * @param {IGraph} graph\n * @param {{ chatType: string; members: [{\"@odata.type\": string,\"roles\": [\"owner\"],\"user@odata.bind\": string},{\"@odata.type\": string,\"roles\": [\"owner\"],\"user@odata.bind\": string}]  }} chatData\n * @return {*}  {Promise<Chat>}\n */\nexport const createChat = async (graph: IGraph, person: string, user: string): Promise<Chat> => {\n  const chatData = {\n    chatType: 'oneonOne',\n    members: [\n      {\n        '@odata.type': '#microsoft.graph.aadUserConversationMember',\n        roles: ['owner'],\n        'user@odata.bind': `https://graph.microsoft.com/v1.0/users('${user}')`\n      },\n      {\n        '@odata.type': '#microsoft.graph.aadUserConversationMember',\n        roles: ['owner'],\n        'user@odata.bind': `https://graph.microsoft.com/v1.0/users('${person}')`\n      }\n    ]\n  };\n  return (await graph\n    .api('/chats')\n    .header('Cache-Control', 'no-store')\n    .middlewareOptions(prepScopes('Chat.Create', 'Chat.ReadWrite'))\n    .post(chatData)) as Chat;\n};\n\n/**\n * Send a chat message to a user\n *\n * @export\n * @param {IGraph} graph\n * @param {{ body: {\"content\": string}  }} messageData\n * @return {*}  {Promise<ChatMessage>}\n */\nexport const sendMessage = async (\n  graph: IGraph,\n  chatId: string,\n  messageData: Pick<ChatMessage, 'body'>\n): Promise<ChatMessage> =>\n  (await graph\n    .api(`/chats/${chatId}/messages`)\n    .header('Cache-Control', 'no-store')\n    .middlewareOptions(prepScopes('Chat.ReadWrite', 'ChatMessage.Send'))\n    .post(messageData)) as ChatMessage;\n"]}